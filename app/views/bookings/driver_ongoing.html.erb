<div class="max-w-7xl mx-auto px-4 py-4 mt-6">
  <h2 class="text-2xl font-bold mb-4 text-gray-800">Ongoing Rides</h2>

  <% if @ongoing_bookings.any? %>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <% @ongoing_bookings.each do |booking| %>
        <div class="bg-white border border-gray-300 rounded-lg shadow-sm flex flex-col text-sm">
          <% if booking.vehicle.image.attached? %>
            <%= image_tag booking.vehicle.image, class: "w-full h-40 object-cover rounded-t-lg" %>
          <% else %>
            <div class="w-full h-40 bg-gray-100 flex items-center justify-center text-gray-500 rounded-t-lg text-sm">
              No Image
            </div>
          <% end %>
          <div class="p-4 flex flex-col flex-1">
            <div class="flex flex-wrap gap-2 mb-2">
              <span class="inline-block bg-gray-100 px-3 py-1 rounded text-sm text-gray-600">
                <strong>From:</strong> <%= booking.start_location.humanize %>
              </span>
              <span class="inline-block bg-gray-100 px-3 py-1 rounded text-sm text-gray-600">
                <strong>To:</strong> <%= booking.end_location.humanize %>
              </span>
            </div>

            <p class="mb-1"><strong class="font-semibold text-gray-800">Vehicle:</strong> <span class="text-gray-700"><%= booking.vehicle.model %></span></p>
            <p class="mb-1"><strong class="font-semibold text-gray-800">Customer:</strong> <span class="text-gray-700"><%= booking.user.name %></span></p>
            <p class="mb-1"><strong class="font-semibold text-gray-800">Start:</strong> <span class="text-gray-700"><%= booking.start_time.strftime("%d %b %Y, %I:%M %p") %></span></p>
            <p class="mb-1"><strong class="font-semibold text-gray-800">Price:</strong> <span class="text-gray-700">‚Çπ<%= booking.price %></span></p>

            <% if booking.cancelled_at.present? %>
              <p class="text-red-600 font-semibold italic mt-2">
                ‚ùå Ride cancelled by <%= booking.cancelled_by&.capitalize || "user" %> at <%= booking.cancelled_at.in_time_zone.strftime("%d %b %Y, %I:%M %p") %>
              </p>
            <% else %>
              <% if booking.payment&.payment_status %>
                <p class="text-green-600 font-semibold italic mt-2">‚úÖ Customer has made the payment.</p>
                <%= button_to "Finish Ride", finish_booking_path(booking), method: :patch,
                      class: "bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded mt-2" %>
              <% elsif Time.current >= booking.start_time %>
                <p class="text-orange-600 italic mt-2">Waiting for customer payment...</p>
              <% end %>

              <% if Time.current < booking.start_time.in_time_zone - 30.minutes %>
                <%= button_to "Cancel", booking_path(booking), method: :delete,
                    data: { confirm: "Are you sure you want to cancel this ride?" },
                    class: "bg-red-600 hover:bg-gray-400 text-white font-semibold py-2 px-3 rounded text-sm mt-2" %>
              <% else %>
                <div class="mt-2" id="countdown-container-<%= booking.id %>">
                  <p class="text-blue-700 font-semibold italic">
                    üïí Ride starts in <span id="countdown-<%= booking.id %>">a few minutes</span>
                  </p>
                </div>

                <script>
                  document.addEventListener("DOMContentLoaded", function () {
                    const countdownEl = document.getElementById("countdown-<%= booking.id %>");
                    const containerEl = document.getElementById("countdown-container-<%= booking.id %>");
                    const rideStartTime = new Date("<%= booking.start_time.in_time_zone.iso8601 %>").getTime();

                    setInterval(function () {
                      const now = new Date().getTime();
                      const distance = rideStartTime - now;

                      if (distance <= 0) {
                        containerEl.style.display = "none";
                      } else {
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        countdownEl.innerText = minutes + " min " + seconds + " sec";
                      }
                    }, 1000);
                  });
                </script>


              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div>
      <p class="text-gray-700 text-md mb-4">You don‚Äôt have any ongoing rides at the moment.</p>
      <%= link_to "Back to Home", home_path,
            class: "inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-md shadow-md no-underline transition-colors duration-200" %>
    </div>
  <% end %>
</div>
